name: Instagram Superpack Extractor

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: macos-14
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Instagram APK from Release
      run: |
        curl -L -o Instagram.apk "https://github.com/Result2025/instagram-superpack-extractor/releases/download/v1.0/Instagram.apk"
        ls -lh Instagram.apk
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Accept licenses
      run: yes | sdkmanager --licenses || true
      
    - name: Install SDK components
      run: |
        sdkmanager "platform-tools" "platforms;android-34" "emulator"
        sdkmanager "system-images;android-34;google_apis;arm64-v8a"
        
    - name: Create AVD
      run: |
        echo "no" | avdmanager create avd -n test_avd -k "system-images;android-34;google_apis;arm64-v8a" --device "pixel_6"
        
    - name: Start Emulator
      run: |
        # Use software rendering to avoid Vulkan memory allocation issues
        $ANDROID_HOME/emulator/emulator -avd test_avd -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot -memory 4096 &
        
        # Wait for device with timeout
        timeout 300 adb wait-for-device || (echo "Emulator failed to start" && exit 1)
        
        # Wait for boot with timeout
        BOOT_TIMEOUT=300
        WAITED=0
        while [ "$(adb shell getprop sys.boot_completed 2>/dev/null)" != "1" ]; do
          sleep 5
          WAITED=$((WAITED + 5))
          if [ $WAITED -ge $BOOT_TIMEOUT ]; then
            echo "Boot timeout after ${BOOT_TIMEOUT}s"
            exit 1
          fi
        done
        echo "Emulator booted successfully"
        
    - name: Install Instagram
      run: |
        adb root
        adb install -g Instagram.apk
        
    - name: Launch and Extract
      run: |
        adb shell am start -n com.instagram.android/.activity.MainTabActivity
        sleep 180
        mkdir -p extracted
        adb pull /data/data/com.instagram.android/lib/ extracted/ || true
        adb pull /data/data/com.instagram.android/files/ extracted/ || true
        ls -laR extracted/
        
    - name: Upload Libraries
      uses: actions/upload-artifact@v4
      with:
        name: instagram-libraries
        path: extracted/
